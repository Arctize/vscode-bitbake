{
    "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
    "scopeName": "source.bb",
    "name": "BitBake",
    "fileTypes": [
        "bb",
        "bbappend",
        "bbclass",
        "inc"
    ],
    "patterns": [
        {
            "include": "#string"
        },
        {
            "begin": "(?<=\\[)",
            "end": "(?=\\])",
            "name": "source.python"
        },
        {
            "include": "#boolean"
        },
        {
            "include": "#numeric"
        },
        {
            "include": "#keywords"
        },
        {
            "include": "#comment"
        },
        {
            "include": "#variable-reference"
        },
        {
            "include": "#functions"
        },
        {
            "include": "#bitbake-operator"
        },
        {
            "include": "#variable-name"
        },
        {
            "include": "#operator"
        }
    ],
    "repository": {
        "keywords":{
            "patterns": [
                {
                    "match": "\\s*(include|from|import|require|inherit|addtask|deltask|after|before|export|echo|if|fi|else|return|unset|print|or|fakeroot|EXPORT_FUNCTIONS|INHERIT)(?=\\s+|\\s*:)",
                    "captures": {
                        "1": {
                            "name": "keyword.control.bb"
                        }
                    }
                },
                {
                    "match": "\\s*(def)(?=\\s+)",
                    "captures": {
                        "1": {
                            "name": "storage.type.function.python.bb"
                        }
                    }
                },
                {
                    "match": "\\s*(python)(?=\\s+|\\s*\\()",
                    "captures": {
                        "1": {
                            "name": "storage.type.function.python.bb"
                        }
                    }
                },
                {
                    "match": "(bbplain|bb|self)(?=\\s+|\\.)",
                    "captures": {
                        "1": {
                            "name": "support.class.built-in-object.bb"
                        }
                    } 
                },
                {
                    "begin": "(?<=import|inherit)(?=\\s+)",
                    "end": "\\n",
                    "name": "support.class.bb",
                    "patterns": [
                        {
                            "include": "#variable-reference"
                        }
                    ]
                }
                
            ]
        },
        "numeric": {
            "match": "(-|\\.)?[0-9]+(\\.[0-9]+)?",
            "name": "constant.numeric.bb"
        },
        "string": {
            "patterns": [
                {
                    "name": "string.quoted.double.bb",
                    "begin": "(\")",
                    "end": "(\")",
                    "patterns": [
                        {
                            "include": "#variable-reference"
                        }
                    ]
                },
                {
                    "name": "string.quoted.single.bb",
                    "begin": "(')",
                    "end": "(')",
                    "patterns": [
                        {
                            "include": "#variable-reference"
                        }
                    ]
                }
            ]
        },
        "comment": {
            "match": "(\\s*)((#)(.*))\\n",
            "captures": {
                "1": {
                    "name": "punctuation.whitespace.comment.leading.bb"
                },
                "2": {
                    "name": "comment.line.bb"
                },
                "3": {
                    "name": "comment.line.number-sign.bb"
                },
                "4": {
                    "name": "comment.line.text.bb"
                }
            }
        },
        "functions": {
            "begin": "\\s*([a-zA-Z_][\\w_]*)(:(append|prepend|remove))?(?=\\s*\\()",
            "beginCaptures": {
                "1": {
                    "name": "entity.name.function.python.bb"
                },
                "2": {
                    "name": "keyword.operator.bb"
                },
                "3": {
                    "name": "keyword.other.bitbake-operator.bb"
                }
            },
            "end": "(?=\\))",
            "patterns": [
                {
                    "include": "#function-params"
                },
                {
                    "include": "#parenthesis-open"
                },
                {
                    "include": "#parenthesis-close"
                }
                  
            ]
        },
        "variable-reference": {
            "begin": "(\\$\\{)",
            "beginCaptures": {
                "1": {
                    "name": "variable.language.bb"
                }
            },
            "end": "(\\})",
            "endCaptures": {
                "1": {
                    "name": "variable.language.bb"
                }
            },
            "patterns": [
                {
                    "match": "(@)",
                    "name": "entity.name.function.decorator.python.bb"
                },
                {
                    "include": "#operator"
                },
                {
                   "include": "#keywords"
                },
                {
                    "match": "(\\[)",
                    "name": "support.function.bracket-open.bb"
                },
                {
                    "match": "(\\])",
                    "name": "support.function.bracket-close.bb"
                },
                {
                    "include": "#numeric"
                },
                {
                    "include": "#functions"
                },
                {
                    "include": "#parenthesis-open"
                },
                {
                    "include": "#parenthesis-close"
                },
                {
                    "include": "#variable-name"
                },
                {
                    "include": "#string"
                }
            ]
        },
        "variable-name": {
            "match": "([a-zA-Z_][\\w_]*)",
            "captures": {
                "1": {
                    "name": "variable.other.names.bb"
                },
                "2": {
                    "name": "keyword.other.bitbake-operator.bb"
                }
            }
        },
        "function-params":{
            "begin": "(?<=\\()",
            "end": "(?=\\))",
            "patterns": [
                {
                    "include": "#boolean"
                },
                {
                    "include": "#numeric"
                },
                {
                    "include": "#string"
                },
                {
                    "include": "#operator"
                },
                {
                    "include": "#functions"
                },
                {
                    "include": "#variable-name"
                }
            ]
        },
        "operator": {
            "match": "(=|\\?=|\\?\\?=|:=|\\+=|=\\+|\\.=|=\\.|\\.|,)",
            "name": "keyword.operator.bb"
        },
        "bitbake-operator":{
            "match": "(?<=:)(os|nooverride|qemuarm|qemumips64|qemumips|qemuppc|qemux86-64|qemux86|append|prepend|remove|task-configure|task-compile)",
            "name": "keyword.other.bitbake-operator.bb"
        },
        "parenthesis-open": {
            "match": "([\\w])*\\(",
            "name": "entity.name.function.parenthesis.open"
        },
        "parenthesis-close": {
            "match": "\\)",
            "name": "entity.name.function.parenthesis.close"
        },
        "boolean": {
            "match": "(?<![\\w_-])(True|False)(?![\\w_-])",
            "name": "constant.language.python.bb"
        }
    }
}