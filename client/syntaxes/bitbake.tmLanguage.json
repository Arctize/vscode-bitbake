{
    "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
    "scopeName": "source.bb",
    "name": "BitBake",
    "fileTypes": [
        "bb",
        "bbappend",
        "bbclass",
        "inc"
    ],
    "patterns": [
        {
            "include": "#string"
        },
        {
            "include": "#keywords"
        },
        {
            "include": "#comment"
        },
        {
            "include": "#variable-assignment"
        },
        {
            "include": "#variable-reference"
        },
        {
            "include": "#functions"
        },
        {
            "include": "#bitbake-operator"
        },
        {
            "include": "#variable-name"
        },
        {
            "include": "#operator"
        },
        {
            "include": "#function-content"
        }
    ],
    "repository": {
        "keywords":{
            "patterns": [
                {
                    "match": "\\s*(include|from|import|require|inherit|addtask|deltask|after|before|export|echo|if|fi|else|return|unset|print|or|EXPORT_FUNCTIONS|INHERIT)(?=\\s+|\\s*:)",
                    "captures": {
                        "1": {
                            "name": "keyword.control.bb"
                        }
                    }
                },
                {
                    "match": "^\\s*(fakeroot)(?=\\s+)",
                    "captures": {
                        "1": {
                            "name": "keyword.control.bb"
                        }
                    }
                },
                {
                    "match": "\\s*(def)(?=\\s+)",
                    "captures": {
                        "1": {
                            "name": "storage.type.function.python.bb"
                        }
                    }
                },
                {
                    "match": "\\s*(python)(?=\\s+|\\s*\\()",
                    "captures": {
                        "1": {
                            "name": "storage.type.function.python.bb"
                        }
                    }
                },
                {
                    "match": "(bbplain|bb)(\\.)?",
                    "captures": {
                        "1": {
                            "name": "support.class.built-in-object.bb"
                        }
                    } 
                },
                {
                    "begin": "(?<=import|inherit)(?=\\s+)",
                    "end": "\\n",
                    "name": "support.class.bb",
                    "patterns": [
                        {
                            "include": "#variable-reference"
                        }
                    ]
                }
            ]
        },
        "string": {
            "patterns": [
                {
                    "name": "string.quoted.double.bb",
                    "begin": "(\")",
                    "end": "(\")",
                    "patterns": [
                        {
                            "include": "#variable-reference"
                        }
                    ]
                },
                {
                    "name": "string.quoted.single.bb",
                    "begin": "'",
                    "end": "'",
                    "patterns": [
                        {
                            "include": "#variable-reference"
                        }
                    ]
                }
            ]
        },
        "comment": {
            "match": "(\\s*)((#)(.*))\\n",
            "captures": {
                "1": {
                    "name": "punctuation.whitespace.comment.leading.bb"
                },
                "2": {
                    "name": "comment.line.bb"
                },
                "3": {
                    "name": "comment.line.number-sign.bb"
                },
                "4": {
                    "name": "comment.line.text.bb"
                }
            }
        },
        "functions": {
            "begin": "\\s*([a-zA-Z0-9_-][\\w-]*)(:(append|prepend|remove))?(?=\\s*\\()",
            "beginCaptures": {
                "1": {
                    "name": "entity.name.function.python.bb"
                },
                "2": {
                    "name": "keyword.operator.bb"
                },
                "3": {
                    "name": "keyword.other.bitbake-operator.bb"
                }
            },
            "end": "(?=\\))",
            "patterns": [
                {
                    "include": "#function-params"
                }  
            ]
        },
        "function-content": {
            "begin": "(?<=\\(.*\\)\\{)",
            "end": "(?=\\})",
            "patterns": [
                {
                    "include": "#string"
                },
                {
                    "include": "#keywords"
                },
                {
                    "include": "#variable-assignment"
                },
                {
                    "include": "#variable-reference"
                }
            ]
        },
        "variable-reference": {
            "begin": "(\\$\\{)",
            "end": "(\\})",
            "name": "variable.language.bb",
            "patterns": [
                {
                   "include": "#keywords"
                },
                {
                    "include": "#functions"
                },
                {
                    "include": "#variable-name"
                },
                {
                    "include": "#string"
                }
            ]
        },
        "variable-name": {
            "match": "([a-zA-Z0-9_-][\\w-]*)(?!\\s*\\()",
            "captures": {
                "1": {
                    "name": "variable.other.names.bb"
                },
                "2": {
                    "name": "keyword.other.bitbake-operator.bb"
                }
            }
        },
        "function-params":{
            "begin": "(?<=\\()",
            "end": "(?=\\))",
            "patterns": [
                {
                    "include": "#functions"
                },
                {
                    "include": "#variable-name"
                },
                {
                    "include": "#variable-assignment"
                },
                {
                    "include": "#string"
                }
            ]
        },
        "operator": {
            "match": "(=|\\?=|\\?\\?=|:=|\\+=|=\\+|\\.=|=\\.)",
            "name": "keyword.operator.bb"
        },
        "bitbake-operator":{
            "match": "(?<=:)(os|nooverride|qemuarm|qemumips64|qemumips|qemuppc|qemux86-64|qemux86|append|prepend|remove|task-configure|task-compile)",
            "name": "keyword.other.bitbake-operator.bb"
        }
    }
}