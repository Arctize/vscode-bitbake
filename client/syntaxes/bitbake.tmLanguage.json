{
    "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
    "scopeName": "source.bb",
    "name": "BitBake",
    "fileTypes": [
        "bb",
        "bbappend",
        "bbclass",
        "inc"
    ],
    "patterns": [
        {
            "include": "#string"
        },
        {
            "include": "#keywords"
        },
        {
            "include": "#comment"
        },
        {
            "include": "#variable-assignment"
        },
        {
            "include": "#variable-reference"
        },
        {
            "include": "#functions"
        },
        {
            "include": "#variable-name"
        },
        {
            "include": "#operator"
        },
        {
            "include": "#function-content"
        }
    ],
    "repository": {
        "keywords":{
            "patterns": [
                {
                    "match": "^\\s*(include|require|inherit|export|echo|if|fi|else|return|EXPORT_FUNCTIONS)(?=\\s+|\\s*:)",
                    "captures": {
                        "1": {
                            "name": "keyword.control.bb"
                        }
                    }
                },
                {
                    "match": "^\\s*(fakeroot)(?=\\s+)",
                    "captures": {
                        "1": {
                            "name": "keyword.control.bb"
                        }
                    }
                },
                {
                    "match": "\\s*(def)(?=\\s+)",
                    "captures": {
                        "1": {
                            "name": "storage.type.function.python.bb"
                        }
                    }
                },
                {
                    "match": "\\s*(python)(?=\\s+|\\s*\\()",
                    "captures": {
                        "1": {
                            "name": "storage.type.function.python.bb"
                        }
                    }
                }
            ]
        },
        "string": {
            "patterns": [
                {
                    "name": "string.quoted.double.bb",
                    "begin": "(\")",
                    "end": "(\")",
                    "patterns": [
                        {
                            "include": "#variable-reference"
                        }
                    ]
                },
                {
                    "name": "string.quoted.single.bb",
                    "begin": "'",
                    "end": "'",
                    "patterns": [
                        {
                            "include": "#variable-reference"
                        }
                    ]
                }
            ]
        },
        "comment": {
            "match": "(\\s*)((#)(.*))\\n",
            "captures": {
                "1": {
                    "name": "punctuation.whitespace.comment.leading.bb"
                },
                "2": {
                    "name": "comment.line.bb"
                },
                "3": {
                    "name": "comment.line.number-sign.bb"
                },
                "4": {
                    "name": "comment.line.text.bb"
                }
            }
        },
        "functions": {
            "begin": "\\s*(\\s+[a-zA-Z0-9_-][\\w-]*)?(\\.)?([a-zA-Z0-9_-][\\w-]*)(:append|:prepend)?(?=\\s*\\()",
            "beginCaptures": {
                "1": {
                    "name": "variable.other.names.bb"
                },
                "2": {
                    "name": "keyword.operator.bb"
                },
                "3": {
                    "name": "entity.name.function.python.bb"
                },
                "4": {
                    "name": "keyword.other.bitbake-operator.bb"
                }
            },
            "end": "(?=\\))",
            "patterns": [
                {
                    "include": "#function-params"
                }  
            ]
        },
        "function-content": {
            "begin": "(?<=\\(.*\\)\\{)",
            "end": "(?=\\})",
            "patterns": [
                {
                    "include": "#variable-assignment"
                },
                {
                    "include": "#string"
                },
                {
                    "include": "#variable-reference"
                }
            ]
        },
        "variable-reference": {
            "patterns": [
                {
                    "match": "(\\$\\{)([a-zA-Z0-9_]*)(\\})",
                    "name": "variable.language.bb",
                    "captures": {
                        "1": {
                            "name": "variable.language.bb"
                        },
                        "2":{
                            "name": "variable.other.bb"
                        }
                    }
                }
            ]
        },
        "variable-name": {
            "match": "\\s*([a-zA-Z0-9_-][\\w-]*)(:append|:prepend:remove)?(?!\\s*\\()",
            "captures": {
                "1": {
                    "name": "variable.other.names.bb"
                },
                "2": {
                    "name": "keyword.other.bitbake-operator.bb"
                }
            }
        },
        "function-params":{
            "begin": "(?<=\\()",
            "end": "(?=\\))",
            "patterns": [
                {
                    "include": "#variable-name"
                },
                {
                    "include": "#variable-assignment"
                },
                {
                    "include": "#string"
                }
            ]
        },
        "operator": {
            "match": "(=|\\?=|\\?\\?=|:=|\\+=|=\\+|\\.=|=\\.)",
            "name": "keyword.operator.bb"
        }
    }
}